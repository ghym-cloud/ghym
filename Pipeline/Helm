pipeline {
  agent any
  triggers {
    githubPush()
  }
  stages {
    stage('Helm') {
      steps {
        sh '''
         for f in $(git diff --name-only HEAD HEAD~1 | grep Helm)
         do
          helm repo update
          repo = $(helm -n ghym ls -qa | grep awk -F '.' '{print $1}' $f)
          helm upgrade -i --atomic --wait --values $f $repo $(helm search repo | grep $repo\ )
         done
        '''
      }
    }
  }
}
